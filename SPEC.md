# Tech & Gov Stream - 機能仕様書 (SPEC.md)

## 概要
X Pro (旧TweetDeck) スタイルの横スクロール型ニュースリーダー。
技術（Tech）と政府・政策（Gov）の最新動向を、ユーザーがカスタマイズしたカラムで効率的に収集・閲覧できるアプリケーション。

---

## 1. ユーザーインターフェース (UI)

### 1-1. レイアウト
- **ストリーム型カラム**: 複数のニュースフィードを横一列に並べ、水平スクロールで閲覧。
- **カラム幅**: 固定幅（340px）。
- **スクロール挙動**: `snap-x` によるスナップスクロール（1カラムずつ停止）。
- **テーマ**: ダークモード（デフォルト）/ライトモード切り替え対応。
- **レスポンシブ**: モバイル端末ではスワイプ操作で快適に閲覧可能。

### 1-2. ヘッダー
- **ロゴ**: アプリタイトル。
- **ソース管理ボタン**: ⚙️ アイコン。クリックで「ソースをカスタマイズ」ダイアログを表示。
- **テーマ切り替え**: ☀️/🌙 アイコンでモード変更。

---

## 2. ニュース閲覧機能

### 2-1. 記事カード
各記事は以下の要素で構成されるカードとして表示。
- **画像（サムネイル）**:
    - RSS内の `media:content`, `enclosure`, `img` タグから自動抽出。
    - 画像がない場合は記事ページからOGP画像を非同期で取得（最大10件/フィード）。
    - 取得失敗時は非表示（レイアウト自動調整）。
    - アスペクト比 16:9 で上部に表示。
- **記事タイトル**: 最大3行まで表示。
- **発行元**: ソース名（Zenn, Qiita, Google Newsなど）をバッジ表示。
- **公開日時**: `MM/DD HH:mm` 形式。
- **要約**: 最大150文字。画像ありの場合は2行、なしの場合は3行まで表示。
- **リンク**: カード全体がクリック可能（別タブで開く）。

### 2-2. 既読管理
- **状態保持**: Zustnad (およびSupabase) にて既読記事のIDリストを管理。
- **自動既読**: 記事カードをクリックしてリンクを開いた際に自動で既読状態になる。
- **UI表示**: 既読になった記事はタイトルの文字色が薄くなり（`text-muted-foreground/80`）、未読記事との視覚的区別がつく。
- **一括既読**: 各カラムのヘッダーにある「✓✓」ボタン（すべて既読にする）で、対象カラムの現在の記事一覧を一括で既読化できる。

### 2-3. Markdownダウンロード
- **機能概要**: 気になった記事をワンクリックでMarkdownファイルとして保存できる機能。
- **抽出処理 (`/api/extract`)**:
    - 対象記事のURLからHTMLを取得し、`@mozilla/readability` で本文のみをクリーンに抽出。
    - `turndown` でHTMLをMarkdownに変換し、YAML Frontmatter（タイトル・元URL・取得日）を自動付与。
- **UI**: 各記事カードに「📥」アイコンを配置。処理中はスピナーが表示される。
- **デバイス別の挙動**:
    - **PC**: `.md` ファイルとしてブラウザのダウンロード機能で保存。
    - **スマホ**: Web Share API（OSの共有メニュー）を呼び出し、Obsidianやメモアプリ等へ直接テキストを転送可能。

### 2-4. 更新機能
- **自動更新**: 5分ごとにバックグラウンドで再取得（SWR `refreshInterval: 300000`）。
- **手動更新**: カラムヘッダーの 🔄 ボタンで即時更新（ローディング中はスケルトンUI）。
- **エラー処理**: 取得失敗時はエラーメッセージと再試行ボタンを表示。

---

## 3. カスタマイズ機能

### 3-1. オンボーディング
- 初回起動時（またはカラム数が0の時）、自動的に「ソースをカスタマイズ」ダイアログを表示。

### 3-2. ソース管理（Source Manager）
以下の3つの方法でカラムを追加可能。

#### A. プリセット（Presets）
厳選されたソースのカタログから選択。
- **Tech**: Zenn, Qiita, TechCrunch JP, Publickey
- **Gov/Policy**: デジタル庁, 経産省, AI規制・政策(Google News), 総務省

#### B. キーワード検索（Keyword）
任意のキーワードを入力し、Google NewsのRSSを生成して追加。
- 例: "生成AI", "Web3", "働き方改革"

#### C. RSS URL直接入力
RSS/AtomフィードのURLを直接指定して追加。

### 3-3. キーワードミュート（フィルタリング）
- **グローバルミュート**: ソース管理ダッシュボードの「ミュート」タブから、任意のNGキーワード（例: "PR", 企業名）を登録可能。
- **適用の挙動**: 登録されたキーワードが「記事タイトル」または「要約」に含まれる場合、すべてのカラムにおいてその記事が非表示（フィルタ）となる。

### 3-4. カラム操作
- **並び替え**: カラムヘッダー左側のハンドル（⋮⋮）をドラッグ＆ドロップして並び替え可能（`dnd-kit`使用）。
- **削除**: カラムヘッダー右側の × ボタンで即座に削除。
- **追加**: カラム末尾の「＋」ボタンからもソース管理画面を開ける。

---

## 4. データ・バックエンド仕様

### 4-1. RSS取得ロジック (`/api/feed`)
- **プロキシ**: CORS回避のため、Next.js Route Handler経由でRSSを取得。
- **パース処理**: `xml2js` を使用。RSS 1.0, 2.0, Atom 形式に対応。
- **正規化**: 異なるフォーマットの差異を吸収し、統一された `Article` オブジェクトに変換。
- **画像抽出優先度**:
    1. `media:content` / `media:thumbnail`
    2. `enclosure` (画像判定ロジック含む)
    3. 本文中の `<img>` タグ
    4. OGP画像 (フォールバック)

### 4-2. 記事本文抽出API (`/api/extract`)
- **抽出エンジン**: `@mozilla/readability` で広告・ナビゲーションを除去した純粋な本文HTMLを取得。
- **変換**: `turndown` でHTML→Markdownに変換。Frontmatter（タイトル・元URL・日付）を自動付与。
- **DOM構築**: `jsdom` を使用し、Node.js環境でReadabilityを実行。

### 4-3. 状態管理
- **Zustand (`useFeedStore`)**:
    - カラム設定、ブックマーク、既読IDリスト、ミュートキーワード、表示モードを管理。
    - `zustand/persist` でローカルストレージに永続化。
    - Supabase連携により、ログインユーザーはクラウドにも同期。

---

## 5. 技術スタック
- **Frontend**: Next.js 15 (App Router), React 19, TypeScript
- **UI Components**: Shadcn/UI (Radix UI), Tailwind CSS v4, Lucide React
- **State Management**: Zustand + Supabase (Cloud Sync)
- **Data Fetching**: SWR
- **Drag & Drop**: @dnd-kit
- **Article Extraction**: @mozilla/readability, jsdom, turndown
- **Utilities**: dayjs, xml2js, clsx

---

## 6. 今後の実装予定
- [x] **Supabase連携**: ユーザー認証、設定のクラウド保存。
- [x] **未読管理**: 既読状態のトラッキング。
- [x] **フィルタリング**: 特定キーワードの除外/強調。
- [x] **Markdownダウンロード**: Readabilityによる本文抽出とMD変換、PC/スマホ対応。
- [ ] **高度なAI連携**: Markdown化された本文を活用したカラム単位の分析やサマリー生成。
